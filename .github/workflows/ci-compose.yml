name: CI - Docker Compose (build + tests + smoke)

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  ci:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Restore
        run: dotnet restore backend/Asisya.sln

      - name: Build
        run: dotnet build backend/Asisya.sln -c Release --no-restore

      - name: Test (Unit + Integration)
        run: dotnet test backend/Asisya.sln -c Release --no-build --logger "trx;LogFileName=test_results.trx"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker Compose build & up
        run: docker compose up -d --build

      - name: Show status
        run: docker compose ps

      - name: Debug on failure
        if: failure()
        run: |
          echo "--- DOCKER PS ---"
          docker compose ps
          echo "--- API LOGS ---"
          docker logs asisya_api --tail 100
          echo "--- DB LOGS ---"
          docker logs asisya_db --tail 100
          echo "--- HEALTHCHECK STATUS ---"
          docker inspect asisya_api --format='{{json .State.Health}}'

      - name: Docker Compose down
        if: always()
        run: docker compose down -v --remove-orphans
