name: CI + Docker Compose

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  test-and-compose:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- .NET tests ----------
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore backend/Asisya.sln

      - name: Build
        run: dotnet build backend/Asisya.sln -c Release --no-restore

      - name: Unit Tests
        run: dotnet test backend/Asisya.UnitTests/Asisya.UnitTests.csproj -c Release --no-build

      - name: Integration Tests (Testcontainers)
        run: dotnet test backend/Asisya.IntegrationTests/Asisya.IntegrationTests.csproj -c Release --no-build

      # ---------- Docker Compose verification ----------
      - name: Compose Build
        run: docker compose build

      - name: Compose Up
        run: docker compose up -d

      - name: Wait for DB health
        run: |
          set -e
          echo "Waiting for db health..."
          for i in {1..40}; do
            STATUS="$(docker inspect --format='{{json .State.Health.Status}}' asisya_db 2>/dev/null || true)"
            if [ "$STATUS" = "\"healthy\"" ]; then
              echo "DB is healthy"
              exit 0
            fi
            sleep 2
          done
          echo "DB did not become healthy"
          docker compose logs db
          exit 1

      - name: Wait for API port
        run: |
          set -e
          echo "Waiting for API on :8080..."
          for i in {1..40}; do
            if curl -fsS http://localhost:8080 >/dev/null 2>&1; then
              echo "API is responding"
              exit 0
            fi
            sleep 2
          done
          echo "API did not respond on :8080"
          docker compose logs api
          exit 1

      - name: Wait for Frontend
        run: |
          set -e
          echo "Waiting for frontend on :3000..."
          for i in {1..40}; do
            if curl -fsS http://localhost:3000 >/dev/null 2>&1; then
              echo "Frontend is responding"
              exit 0
            fi
            sleep 2
          done
          echo "Frontend did not respond on :3000"
          docker compose logs frontend
          exit 1

      - name: Logs (always)
        if: always()
        run: docker compose logs --no-color

      - name: Down (always)
        if: always()
        run: docker compose down -v --remove-orphans
